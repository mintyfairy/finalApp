<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.fa.plus.mapper.SiteMapper">

	<insert id="insertCart" parameterType="com.fa.plus.domain.site.SiteCart">
		insert into sitecart(memberIdx,detailNum,STARTDATE,ENDDATE,REG_DATE	) 
  			  values(#{memberIdx},#{detailNum},#{startDate},#{endDate},sysdate)
		
	</insert>
	<delete id="deleteCart" parameterType="com.fa.plus.domain.site.SiteCart">
		DELETE FROM sitecart WHERE  detailNum = #{detailNum} and memberIdx=#{memberIdx}
	</delete>
	<select id="findByCart" parameterType="com.fa.plus.domain.site.SiteCart" resultType="com.fa.plus.domain.site.SiteCart">
		
		 select memberIdx,detailNum,to_char(STARTDATE,'yyyy-mm-dd') STARTDATE,to_char(ENDDATE,'yyyy-mm-dd') ENDDATE,to_char(REG_DATE,'yyyy-mm-dd') REG_DATE,filename thumbnail
		FROM sitecart 
		left join (select filename,detailNum dnum from sitedetailpic 
        where detailNum = #{detailNum}
        ORDER BY sdpicnum 
		FETCH FIRST 1 ROWS ONLY
        ) on dnum=detailNum
		WHERE detailNum = #{detailNum} and  memberIdx=#{memberIdx}
	</select>
	
	<select id="listCart" parameterType="Long" resultType="com.fa.plus.domain.site.SiteCart">
		SELECT memberIdx,sitecart.detailNum,to_char(STARTDATE,'yyyy-mm-dd') STARTDATE,to_char(ENDDATE,'yyyy-mm-dd') ENDDATE,detailName,price,content,capacity,floor,filename thumbnail
		FROM sitecart left join sitedetail  on sitedetail.detailNum=sitecart.detailNum
		left join(select * from (select row_number() over(partition by detailNum order by sdpicnum) rnum,filename,detailNum dnum from sitedetailpic 
       ) where rnum=1) on dnum=sitecart.detailNum
		WHERE memberIdx=#{memberIdx}
	</select>
	
	<select id="dataCountCart" parameterType="Long" resultType="Integer">
		SELECT NVL(COUNT(*), 0)
		FROM sitecart 
		where memberIdx=#{memberIdx}
	</select>
	<insert id="insertBookList" parameterType="map">
		insert into booklist(LISTNUM,ORDER_DATE,memberIdx,TOTALPRICE,STATE) 
			values(booklist_seq.nextval,sysdate,#{memberIdx},#{totalPrice},0)
		
	</insert>
	
	<insert id="insertBook" parameterType="com.fa.plus.domain.site.SiteCart">
		insert into book(BOOKNUM,STARTDATE,ENDDATE ,BOOKPRICE ,detailNum ,LISTNUM) 
			VALUES(book_seq.nextval,#{startDate},#{endDate},#{bookPrice},#{detailNum},booklist_seq.currval)
		
	</insert>
	
	<insert id="perchaseSite" parameterType="map">
		INSERT into bookpayment(BOOKNUM,PURCHASECOST,PURCHASEMETHOD,PURCHASEDATE) 
		values(booklist_seq.currval,#{totalPrice},#{perchaseMethod},sysdate)
		
	</insert>
	<delete id="deleteAllCart" parameterType="long">
		DELETE FROM sitecart WHERE memberIdx=#{memberIdx}
	</delete>
	<sql id="where-list-cart">
		
		<choose>
			<when test="memberIdx!=null and memberIdx!=''">
				 memberIdx=#{memberIdx}
			</when>
			<when test="minFee!=null and minFee!=''">
				 memberIdx=#{memberIdx}
			</when>
			<when test="maxFee!=null and maxFee!=''">
				 memberIdx=#{memberIdx}
			</when>
		</choose>
	</sql>
	<select id="listBookList" parameterType="Long" resultType="com.fa.plus.domain.site.BookList">
		SELECT listNum,to_char(order_date,'yyyy-mm-dd') order_date, memberIdx,totalPrice 
		FROM booklist 
		WHERE memberIdx=#{memberIdx}
	</select>
	<select id="listBook" parameterType="Long" resultType="com.fa.plus.domain.site.BookList">
		SELECT bookNum,to_char(STARTDATE,'yyyy-mm-dd') STARTDATE,to_char(ENDDATE,'yyyy-mm-dd') ENDDATE,bookPrice, detailNum,listNum
		FROM book
		WHERE listnum=#{listNum}
	</select>
		<insert id="insertReview" parameterType="com.fa.plus.domain.site.SiteDetail">
	insert into sitereview(BOOKNUM,SUBJECT,CONTENT,memberIdx,SCORE,REG_DATE,ANSWER,detailNum,siteNum,ENABLED)
		
		values(#{bookNum },#{siteNum},#{detailName},#{price},#{area},#{content},#{capacity},#{floor})
	
		
	</insert>
	
	<!-- 추가 이미지 등록 -->
	<insert id="insertReviewFile" parameterType="com.fa.plus.domain.site.SiteDetail">
		INSERT INTO sitedetailPic(SdPICNUM, detailNum, fileName)
			VALUES(sitedetailPic_SEQ.NEXTVAL, #{detailNum}, #{fileName})
	</insert>
	
	
	
<!-- 리뷰 등록될떄마다 갱신 -->
<!-- update test set avenum=round((select avg(totalmoney) from productorder)/1000000,1) where num=1; -->
</mapper>